= ДЗ по занятию 18

== Задание

https://docs.google.com/document/d/1mqXKbmIBJq5P6Qwh-9hZE_T2AK-sdlyJ9mKFQ0gNwRU/edit#

[NOTE]
В разделе "7.5 Ошибка при обработке партиции"
я описал ошибку при выполнении учебного скрипта и попытку ее исправления.

== Инсталляция

* В прошлом ДЗ по хайву я инсталлировал его в GCP полностью и делал все там, но там были сложности с конфигурированием и, т.к. я пока новичок в этом деле, решил сделать это ДЗ по другому методу, стандартному, через учебный докер-образ на локальной машине.

== Наполнил файлы

[source, bash]
----
[root@quickstart home]# vi employee.txt
[root@quickstart home]# vi employee_id.txt
[root@quickstart home]# vi employee_hr.txt
[root@quickstart home]# vi employee_contract.txt
[root@quickstart home]# ll
total 20
drwxrwxr-x. 8 cloudera cloudera 4096 Oct 23  2017 cloudera
-rw-r--r--. 1 root     root      389 Mar  5 12:04 employee_contract.txt
-rw-r--r--. 1 root     root      131 Mar  5 12:03 employee_hr.txt
-rw-r--r--. 1 root     root     1470 Mar  5 12:03 employee_id.txt
-rw-r--r--. 1 root     root      228 Mar  5 12:02 employee.txt
[root@quickstart home]# cd ..
[root@quickstart /]# beeline -u "jdbc:hive2://localhost:10000/default" --silent=true
----

=== Data definition and description

==== 1. Data types

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> CREATE TABLE employee (
0: jdbc:hive2://localhost:10000/default>   name string,
0: jdbc:hive2://localhost:10000/default>   work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default>   gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default>   skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default>   depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> COLLECTION ITEMS TERMINATED BY ','
0: jdbc:hive2://localhost:10000/default> MAP KEYS TERMINATED BY ':'
0: jdbc:hive2://localhost:10000/default> STORED AS TEXTFILE;
0: jdbc:hive2://localhost:10000/default> !table employee
+------------+--------------+-------------+-------------+----------+--+
| TABLE_CAT  | TABLE_SCHEM  | TABLE_NAME  | TABLE_TYPE  | REMARKS  |
+------------+--------------+-------------+-------------+----------+--+
|            | default      | employee    | TABLE       | NULL     |
+------------+--------------+-------------+-------------+----------+--+
0: jdbc:hive2://localhost:10000/default> !column employee
+------------+--------------+-------------+---------------+------------+--------------------------------+--------------+----------------+-----------------+-----------------+-----------+----------+-------------+----------------+-------------------+--------------------+-------------------+--------------+----------------+---------------+--------------+-------------------+--------------------+--+
| TABLE_CAT  | TABLE_SCHEM  | TABLE_NAME  |  COLUMN_NAME  | DATA_TYPE  |           TYPE_NAME            | COLUMN_SIZE  | BUFFER_LENGTH  | DECIMAL_DIGITS  | NUM_PREC_RADIX  | NULLABLE  | REMARKS  | COLUMN_DEF  | SQL_DATA_TYPE  | SQL_DATETIME_SUB  | CHAR_OCTET_LENGTH  | ORDINAL_POSITION  | IS_NULLABLE  | SCOPE_CATALOG  | SCOPE_SCHEMA  | SCOPE_TABLE  | SOURCE_DATA_TYPE  | IS_AUTO_INCREMENT  |
+------------+--------------+-------------+---------------+------------+--------------------------------+--------------+----------------+-----------------+-----------------+-----------+----------+-------------+----------------+-------------------+--------------------+-------------------+--------------+----------------+---------------+--------------+-------------------+--------------------+--+
| NULL       | default      | employee    | name          | 12         | STRING                         | 2147483647   | NULL           | NULL            | NULL            | 1         | NULL     | NULL        | NULL           | NULL              | NULL               | 1                 | YES          | NULL           | NULL          | NULL         | NULL              | NO                 |
| NULL       | default      | employee    | work_place    | 2003       | array<string>                  | NULL         | NULL           | NULL            | NULL            | 1         | NULL     | NULL        | NULL           | NULL              | NULL               | 2                 | YES          | NULL           | NULL          | NULL         | NULL              | NO                 |
| NULL       | default      | employee    | gender_age    | 2002       | struct<gender:string,age:int>  | NULL         | NULL           | NULL            | NULL            | 1         | NULL     | NULL        | NULL           | NULL              | NULL               | 3                 | YES          | NULL           | NULL          | NULL         | NULL              | NO                 |
| NULL       | default      | employee    | skills_score  | 2000       | map<string,int>                | NULL         | NULL           | NULL            | NULL            | 1         | NULL     | NULL        | NULL           | NULL              | NULL               | 4                 | YES          | NULL           | NULL          | NULL         | NULL              | NO                 |
| NULL       | default      | employee    | depart_title  | 2000       | map<string,array<string>>      | NULL         | NULL           | NULL            | NULL            | 1         | NULL     | NULL        | NULL           | NULL              | NULL               | 5                 | YES          | NULL           | NULL          | NULL         | NULL              | NO                 |
+------------+--------------+-------------+---------------+------------+--------------------------------+--------------+----------------+-----------------+-----------------+-----------+----------+-------------+----------------+-------------------+--------------------+-------------------+--------------+----------------+---------------+--------------+-------------------+--------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> LOAD DATA LOCAL INPATH 'home/employee.txt' OVERWRITE INTO TABLE employee;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Query the whole table
0: jdbc:hive2://localhost:10000/default> SELECT * FROM employee;
+----------------+-------------------------+-------------------------------+------------------------+----------------------------------------+--+
| employee.name  |   employee.work_place   |      employee.gender_age      | employee.skills_score  |         employee.depart_title          |
+----------------+-------------------------+-------------------------------+------------------------+----------------------------------------+--+
| Michael        | ["Montreal","Toronto"]  | {"gender":"Male","age":30}    | {"DB":80}              | {"Product":["Developer^DLead"]}        |
| Will           | ["Montreal"]            | {"gender":"Male","age":35}    | {"Perl":85}            | {"Product":["Lead"],"Test":["Lead"]}   |
| Shelley        | ["New York"]            | {"gender":"Female","age":27}  | {"Python":80}          | {"Test":["Lead"],"COE":["Architect"]}  |
| Lucy           | ["Vancouver"]           | {"gender":"Female","age":57}  | {"Sales":89,"HR":94}   | {"Sales":["Lead"]}                     |
+----------------+-------------------------+-------------------------------+------------------------+----------------------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Query the ARRAY in the table
0: jdbc:hive2://localhost:10000/default> SELECT work_place FROM employee;
+-------------------------+--+
|       work_place        |
+-------------------------+--+
| ["Montreal","Toronto"]  |
| ["Montreal"]            |
| ["New York"]            |
| ["Vancouver"]           |
+-------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT work_place[0] AS col_1, work_place[1] AS col_2, work_place[2] AS col_3 FROM employee;
+------------+----------+--------+--+
|   col_1    |  col_2   | col_3  |
+------------+----------+--------+--+
| Montreal   | Toronto  | NULL   |
| Montreal   | NULL     | NULL   |
| New York   | NULL     | NULL   |
| Vancouver  | NULL     | NULL   |
+------------+----------+--------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Query the STRUCT in the table
0: jdbc:hive2://localhost:10000/default> SELECT gender_age FROM employee;
+-------------------------------+--+
|          gender_age           |
+-------------------------------+--+
| {"gender":"Male","age":30}    |
| {"gender":"Male","age":35}    |
| {"gender":"Female","age":27}  |
| {"gender":"Female","age":57}  |
+-------------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT gender_age.gender, gender_age.age FROM employee;
+---------+------+--+
| gender  | age  |
+---------+------+--+
| Male    | 30   |
| Male    | 35   |
| Female  | 27   |
| Female  | 57   |
+---------+------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Query the MAP in the table
0: jdbc:hive2://localhost:10000/default> SELECT skills_score FROM employee;
+-----------------------+--+
|     skills_score      |
+-----------------------+--+
| {"DB":80}             |
| {"Perl":85}           |
| {"Python":80}         |
| {"Sales":89,"HR":94}  |
+-----------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT name, skills_score['DB'] AS DB, 
0: jdbc:hive2://localhost:10000/default> skills_score['Perl'] AS Perl, skills_score['Python'] AS Python, 
0: jdbc:hive2://localhost:10000/default> skills_score['Sales'] as Sales, skills_score['HR'] as HR FROM employee;
+----------+-------+-------+---------+--------+-------+--+
|   name   |  db   | perl  | python  | sales  |  hr   |
+----------+-------+-------+---------+--------+-------+--+
| Michael  | 80    | NULL  | NULL    | NULL   | NULL  |
| Will     | NULL  | 85    | NULL    | NULL   | NULL  |
| Shelley  | NULL  | NULL  | 80      | NULL   | NULL  |
| Lucy     | NULL  | NULL  | NULL    | 89     | 94    |
+----------+-------+-------+---------+--------+-------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT depart_title FROM employee;
+----------------------------------------+--+
|              depart_title              |
+----------------------------------------+--+
| {"Product":["Developer^DLead"]}        |
| {"Product":["Lead"],"Test":["Lead"]}   |
| {"Test":["Lead"],"COE":["Architect"]}  |
| {"Sales":["Lead"]}                     |
+----------------------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT name, depart_title['Product'] AS Product, depart_title['Test'] AS Test,
0: jdbc:hive2://localhost:10000/default> depart_title['COE'] AS COE, depart_title['Sales'] AS Sales  
0: jdbc:hive2://localhost:10000/default> FROM employee;
+----------+----------------------+-----------+----------------+-----------+--+
|   name   |       product        |   test    |      coe       |   sales   |
+----------+----------------------+-----------+----------------+-----------+--+
| Michael  | ["Developer^DLead"]  | NULL      | NULL           | NULL      |
| Will     | ["Lead"]             | ["Lead"]  | NULL           | NULL      |
| Shelley  | NULL                 | ["Lead"]  | ["Architect"]  | NULL      |
| Lucy     | NULL                 | NULL      | NULL           | ["Lead"]  |
+----------+----------------------+-----------+----------------+-----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT name, 
0: jdbc:hive2://localhost:10000/default> depart_title['Product'][0] AS product_col0, 
0: jdbc:hive2://localhost:10000/default> depart_title['Test'][0] AS test_col0 
0: jdbc:hive2://localhost:10000/default> FROM employee;
+----------+------------------+------------+--+
|   name   |   product_col0   | test_col0  |
+----------+------------------+------------+--+
| Michael  | Developer^DLead  | NULL       |
| Will     | Lead             | Lead       |
| Shelley  | NULL             | Lead       |
| Lucy     | NULL             | NULL       |
+----------+------------------+------------+--+
----

==== 2. Databases

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Create database without checking if the database already exists.
0: jdbc:hive2://localhost:10000/default> CREATE DATABASE hivetest;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create database and checking if the database already exists.
0: jdbc:hive2://localhost:10000/default> CREATE DATABASE IF NOT EXISTS hivetest;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create database with location, comments, and metadata information
0: jdbc:hive2://localhost:10000/default> CREATE DATABASE IF NOT EXISTS hivetest
0: jdbc:hive2://localhost:10000/default> COMMENT 'hive database demo'
0: jdbc:hive2://localhost:10000/default> LOCATION '/hdfs/directory'
0: jdbc:hive2://localhost:10000/default> WITH DBPROPERTIES ('creator'='cloudera','date'='2019-07-17');
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Show and describe database with wildcards
0: jdbc:hive2://localhost:10000/default> SHOW DATABASES;
+----------------+--+
| database_name  |
+----------------+--+
| default        |
| hivetest       |
+----------------+--+
0: jdbc:hive2://localhost:10000/default> SHOW DATABASES LIKE 'hive.*';
+----------------+--+
| database_name  |
+----------------+--+
| hivetest       |
+----------------+--+
0: jdbc:hive2://localhost:10000/default> DESCRIBE DATABASE hivetest;
+-----------+----------+----------------------------------------------------+-------------+-------------+-------------+--+
|  db_name  | comment  |                      location                      | owner_name  | owner_type  | parameters  |
+-----------+----------+----------------------------------------------------+-------------+-------------+-------------+--+
| hivetest  |          | hdfs://quickstart.cloudera:8020/user/hive/warehouse/hivetest.db | anonymous   | USER        |             |
+-----------+----------+----------------------------------------------------+-------------+-------------+-------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Use the database
0: jdbc:hive2://localhost:10000/default> USE hivetest;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Show current database
0: jdbc:hive2://localhost:10000/default> SELECT current_database();
+-----------+--+
|    _c0    |
+-----------+--+
| hivetest  |
+-----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Drop the empty database.
0: jdbc:hive2://localhost:10000/default> DROP DATABASE IF EXISTS hivetest;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Drop database with CASCADE
0: jdbc:hive2://localhost:10000/default> DROP DATABASE IF EXISTS hivetest CASCADE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> ALTER DATABASE hivetest SET OWNER user cloudera;
Error: Error while compiling statement: FAILED: SemanticException [Error 10072]: Database does not exist: hivetest (state=42000,code=10072)
----

==== 3. Table creation

Возвращаем default как текущую после удаления hivetest

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> select current_database();
+-----------+--+
|    _c0    |
+-----------+--+
| hivetest  |
+-----------+--+
0: jdbc:hive2://localhost:10000/default> use default;
0: jdbc:hive2://localhost:10000/default> select current_database();
+----------+--+
|   _c0    |
+----------+--+
| default  |
+----------+--+
----

Собственно создание таблиц

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Create internal table and load the data
0: jdbc:hive2://localhost:10000/default> CREATE TABLE IF NOT EXISTS employee_internal (
0: jdbc:hive2://localhost:10000/default>   name string,
0: jdbc:hive2://localhost:10000/default>   work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default>   gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default>   skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default>   depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> COMMENT 'This is an internal table'
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> COLLECTION ITEMS TERMINATED BY ','
0: jdbc:hive2://localhost:10000/default> MAP KEYS TERMINATED BY ':'
0: jdbc:hive2://localhost:10000/default> STORED AS TEXTFILE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> LOAD DATA LOCAL INPATH 'home/employee.txt' OVERWRITE INTO TABLE employee_internal;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create external table and load the data
0: jdbc:hive2://localhost:10000/default> CREATE EXTERNAL TABLE IF NOT EXISTS employee_external (
0: jdbc:hive2://localhost:10000/default>    name string,
0: jdbc:hive2://localhost:10000/default>    work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default>    gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default>    skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default>    depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> COMMENT 'This is an external table'
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> COLLECTION ITEMS TERMINATED BY ','
0: jdbc:hive2://localhost:10000/default> MAP KEYS TERMINATED BY ':'
0: jdbc:hive2://localhost:10000/default> STORED AS TEXTFILE
0: jdbc:hive2://localhost:10000/default> LOCATION '/user/cloudera/employee';
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> LOAD DATA LOCAL INPATH 'home/employee.txt' OVERWRITE INTO TABLE employee_external;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Temporary tables
0: jdbc:hive2://localhost:10000/default> CREATE TEMPORARY TABLE IF NOT EXISTS tmp_emp1 (
0: jdbc:hive2://localhost:10000/default> name string,
0: jdbc:hive2://localhost:10000/default> work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default> gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default> skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default> depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> ); 
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> CREATE TEMPORARY TABLE tmp_emp2 AS SELECT * FROM tmp_emp1;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> CREATE TEMPORARY TABLE tmp_emp3 LIKE tmp_emp1;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create Table With Data - CREATE TABLE AS SELECT (CTAS)
0: jdbc:hive2://localhost:10000/default> CREATE TABLE ctas_employee AS SELECT * FROM employee_external;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create Table As SELECT (CTAS) with Common Table Expression (CTE) 
0: jdbc:hive2://localhost:10000/default> CREATE TABLE cte_employee AS
0: jdbc:hive2://localhost:10000/default> WITH r1 AS (SELECT name FROM r2 WHERE name = 'Michael'),
0: jdbc:hive2://localhost:10000/default> r2 AS (SELECT name FROM employee WHERE gender_age.gender= 'Male'),
0: jdbc:hive2://localhost:10000/default> r3 AS (SELECT name FROM employee WHERE gender_age.gender= 'Female')
0: jdbc:hive2://localhost:10000/default> SELECT * FROM r1 UNION ALL select * FROM r3;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT * FROM cte_employee;
+--------------------+--+
| cte_employee.name  |
+--------------------+--+
| Michael            |
| Shelley            |
| Lucy               |
+--------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create Table Without Data - TWO ways 
0: jdbc:hive2://localhost:10000/default> --With CTAS
0: jdbc:hive2://localhost:10000/default> CREATE TABLE empty_ctas_employee AS SELECT * FROM employee_internal WHERE 1=2;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --With LIKE
0: jdbc:hive2://localhost:10000/default> CREATE TABLE empty_like_employee LIKE employee_internal;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Check row count for both tables
0: jdbc:hive2://localhost:10000/default> SELECT COUNT(*) AS row_cnt FROM empty_ctas_employee;
+----------+--+
| row_cnt  |
+----------+--+
| 0        |
+----------+--+
0: jdbc:hive2://localhost:10000/default> SELECT COUNT(*) AS row_cnt FROM empty_like_employee;
+----------+--+
| row_cnt  |
+----------+--+
| 0        |
+----------+--+
----

==== 4. Table description

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Show tables
0: jdbc:hive2://localhost:10000/default> SHOW TABLES;
+----------------------+--+
|       tab_name       |
+----------------------+--+
| ctas_employee        |
| cte_employee         |
| employee             |
| employee_external    |
| employee_internal    |
| empty_ctas_employee  |
| empty_like_employee  |
| tmp_emp1             |
| tmp_emp2             |
| tmp_emp3             |
+----------------------+--+
0: jdbc:hive2://localhost:10000/default> SHOW TABLES '*emp*';
+----------------------+--+
|       tab_name       |
+----------------------+--+
| ctas_employee        |
| cte_employee         |
| employee             |
| employee_external    |
| employee_internal    |
| empty_ctas_employee  |
| empty_like_employee  |
| tmp_emp1             |
| tmp_emp2             |
| tmp_emp3             |
+----------------------+--+
0: jdbc:hive2://localhost:10000/default> SHOW TABLES '*ext*|*cte*';
+--------------------+--+
|      tab_name      |
+--------------------+--+
| cte_employee       |
| employee_external  |
+--------------------+--+
0: jdbc:hive2://localhost:10000/default> SHOW TABLE EXTENDED LIKE 'employee_int*';
+----------------------------------------------------+--+
|                      tab_name                      |
+----------------------------------------------------+--+
| tableName:employee_internal                        |
| owner:anonymous                                    |
| location:hdfs://quickstart.cloudera:8020/user/hive/warehouse/employee_internal |
| inputformat:org.apache.hadoop.mapred.TextInputFormat |
| outputformat:org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat |
| columns:struct columns { string name, list<string> work_place, struct<gender:string,age:i32> gender_age, map<string,i32> skills_score, map<string,list<string>> depart_title} |
| partitioned:false                                  |
| partitionColumns:                                  |
| totalNumberFiles:1                                 |
| totalFileSize:228                                  |
| maxFileSize:228                                    |
| minFileSize:228                                    |
| lastAccessTime:1583412558014                       |
| lastUpdateTime:1583412558043                       |
|                                                    |
+----------------------------------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Show columns
0: jdbc:hive2://localhost:10000/default> SHOW COLUMNS IN employee_internal;
+---------------+--+
|     field     |
+---------------+--+
| name          |
| work_place    |
| gender_age    |
| skills_score  |
| depart_title  |
+---------------+--+
0: jdbc:hive2://localhost:10000/default> DESC employee_internal;
+---------------+--------------------------------+----------+--+
|   col_name    |           data_type            | comment  |
+---------------+--------------------------------+----------+--+
| name          | string                         |          |
| work_place    | array<string>                  |          |
| gender_age    | struct<gender:string,age:int>  |          |
| skills_score  | map<string,int>                |          |
| depart_title  | map<string,array<string>>      |          |
+---------------+--------------------------------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Show DDL and property
0: jdbc:hive2://localhost:10000/default> SHOW CREATE TABLE employee_internal;
+----------------------------------------------------+--+
|                   createtab_stmt                   |
+----------------------------------------------------+--+
| CREATE TABLE `employee_internal`(                  |
|   `name` string,                                   |
|   `work_place` array<string>,                      |
|   `gender_age` struct<gender:string,age:int>,      |
|   `skills_score` map<string,int>,                  |
|   `depart_title` map<string,array<string>>)        |
| COMMENT 'This is an internal table'                |
| ROW FORMAT SERDE                                   |
|   'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe'  |
| WITH SERDEPROPERTIES (                             |
|   'colelction.delim'=',',                          |
|   'field.delim'='|',                               |
|   'mapkey.delim'=':',                              |
|   'serialization.format'='|')                      |
| STORED AS INPUTFORMAT                              |
|   'org.apache.hadoop.mapred.TextInputFormat'       |
| OUTPUTFORMAT                                       |
|   'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat' |
| LOCATION                                           |
|   'hdfs://quickstart.cloudera:8020/user/hive/warehouse/employee_internal' |
| TBLPROPERTIES (                                    |
|   'COLUMN_STATS_ACCURATE'='true',                  |
|   'numFiles'='1',                                  |
|   'numRows'='0',                                   |
|   'rawDataSize'='0',                               |
|   'totalSize'='228',                               |
|   'transient_lastDdlTime'='1583412558')            |
+----------------------------------------------------+--+
0: jdbc:hive2://localhost:10000/default> SHOW TBLPROPERTIES employee_internal;
+------------------------+----------------------------+--+
|       prpt_name        |         prpt_value         |
+------------------------+----------------------------+--+
| COLUMN_STATS_ACCURATE  | true                       |
| comment                | This is an internal table  |
| numFiles               | 1                          |
| numRows                | 0                          |
| rawDataSize            | 0                          |
| totalSize              | 228                        |
| transient_lastDdlTime  | 1583412558                 |
+------------------------+----------------------------+--+
----

==== 5. Table clear

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Drop table 
0: jdbc:hive2://localhost:10000/default> DROP TABLE IF EXISTS empty_ctas_employee;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> DROP TABLE IF EXISTS empty_like_employee;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Truncate table
0: jdbc:hive2://localhost:10000/default> SELECT * FROM cte_employee;
+--------------------+--+
| cte_employee.name  |
+--------------------+--+
| Michael            |
| Shelley            |
| Lucy               |
+--------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> TRUNCATE TABLE cte_employee;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT * FROM cte_employee;
+--------------------+--+
| cte_employee.name  |
+--------------------+--+
+--------------------+--+
----

==== 6. Table alter

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Alter table name
0: jdbc:hive2://localhost:10000/default> ALTER TABLE cte_employee RENAME TO cte_employee_backup;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Alter table properties, such as comments
0: jdbc:hive2://localhost:10000/default> ALTER TABLE cte_employee_backup SET TBLPROPERTIES ('comment' = 'New comments');
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Alter table delimiter through SerDe properties
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal SET SERDEPROPERTIES ('field.delim' = '$');
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Alter Table File Format
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal SET FILEFORMAT RCFILE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Alter Table Location
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal SET LOCATION 'hdfs://localhost:9000/user/cloudera/employee'; 
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Alter Table Location
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal ENABLE NO_DROP; 
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal DISABLE NO_DROP; 
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal ENABLE OFFLINE;
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal DISABLE OFFLINE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Alter Table Concatenate to merge small files into larger files
0: jdbc:hive2://localhost:10000/default> --convert to the file format supported
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal SET FILEFORMAT ORC;
0: jdbc:hive2://localhost:10000/default>  
0: jdbc:hive2://localhost:10000/default> --convert to the regular file format
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal SET FILEFORMAT TEXTFILE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Alter columns
0: jdbc:hive2://localhost:10000/default> --Change column type - before changes
0: jdbc:hive2://localhost:10000/default> DESC employee_internal; 
+---------------+--------------------------------+----------+--+
|   col_name    |           data_type            | comment  |
+---------------+--------------------------------+----------+--+
| name          | string                         |          |
| work_place    | array<string>                  |          |
| gender_age    | struct<gender:string,age:int>  |          |
| skills_score  | map<string,int>                |          |
| depart_title  | map<string,array<string>>      |          |
+---------------+--------------------------------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Change column type
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal CHANGE name employee_name string AFTER gender_age;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Verify the changes 
0: jdbc:hive2://localhost:10000/default> DESC employee_internal; 
+----------------+--------------------------------+----------+--+
|    col_name    |           data_type            | comment  |
+----------------+--------------------------------+----------+--+
| work_place     | array<string>                  |          |
| gender_age     | struct<gender:string,age:int>  |          |
| employee_name  | string                         |          |
| skills_score   | map<string,int>                |          |
| depart_title   | map<string,array<string>>      |          |
+----------------+--------------------------------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Change column type
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_internal CHANGE employee_name name string COMMENT 'updated' FIRST;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Verify the changes 
0: jdbc:hive2://localhost:10000/default> DESC employee_internal; 
+---------------+--------------------------------+----------+--+
|   col_name    |           data_type            | comment  |
+---------------+--------------------------------+----------+--+
| name          | string                         | updated  |
| work_place    | array<string>                  |          |
| gender_age    | struct<gender:string,age:int>  |          |
| skills_score  | map<string,int>                |          |
| depart_title  | map<string,array<string>>      |          |
+---------------+--------------------------------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Add columns to the table
0: jdbc:hive2://localhost:10000/default> ALTER TABLE ctas_employee ADD COLUMNS (work string);
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Verify the added columns
0: jdbc:hive2://localhost:10000/default> DESC ctas_employee;      
+---------------+--------------------------------+----------+--+
|   col_name    |           data_type            | comment  |
+---------------+--------------------------------+----------+--+
| name          | string                         |          |
| work_place    | array<string>                  |          |
| gender_age    | struct<gender:string,age:int>  |          |
| skills_score  | map<string,int>                |          |
| depart_title  | map<string,array<string>>      |          |
| work          | string                         |          |
+---------------+--------------------------------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Replace all columns
0: jdbc:hive2://localhost:10000/default> ALTER TABLE ctas_employee REPLACE COLUMNS (name string);
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Verify the replaced all columns
0: jdbc:hive2://localhost:10000/default> DESC ctas_employee;
+-----------+------------+----------+--+
| col_name  | data_type  | comment  |
+-----------+------------+----------+--+
| name      | string     |          |
+-----------+------------+----------+--+
----

==== 7. Table partitioning

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Create partition table DDL
0: jdbc:hive2://localhost:10000/default> CREATE TABLE employee_partitioned
0: jdbc:hive2://localhost:10000/default> (
0: jdbc:hive2://localhost:10000/default>   name string,
0: jdbc:hive2://localhost:10000/default>   work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default>   gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default>   skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default>   depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> PARTITIONED BY (Year INT, Month INT)
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> COLLECTION ITEMS TERMINATED BY ','
0: jdbc:hive2://localhost:10000/default> MAP KEYS TERMINATED BY ':';
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Check partition table structure
0: jdbc:hive2://localhost:10000/default> DESC employee_partitioned;
+--------------------------+--------------------------------+-----------------------+--+
|         col_name         |           data_type            |        comment        |
+--------------------------+--------------------------------+-----------------------+--+
| name                     | string                         |                       |
| work_place               | array<string>                  |                       |
| gender_age               | struct<gender:string,age:int>  |                       |
| skills_score             | map<string,int>                |                       |
| depart_title             | map<string,array<string>>      |                       |
| year                     | int                            |                       |
| month                    | int                            |                       |
|                          | NULL                           | NULL                  |
| # Partition Information  | NULL                           | NULL                  |
| # col_name               | data_type                      | comment               |
|                          | NULL                           | NULL                  |
| year                     | int                            |                       |
| month                    | int                            |                       |
+--------------------------+--------------------------------+-----------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Show partitions
0: jdbc:hive2://localhost:10000/default> SHOW PARTITIONS employee_partitioned;
+------------+--+
| partition  |
+------------+--+
+------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Add multiple partitions
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned ADD 
0: jdbc:hive2://localhost:10000/default> PARTITION (year=2018, month=11)        
0: jdbc:hive2://localhost:10000/default> PARTITION (year=2018, month=12);
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SHOW PARTITIONS employee_partitioned;
+---------------------+--+
|      partition      |
+---------------------+--+
| year=2018/month=11  |
| year=2018/month=12  |
+---------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Drop partitions
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned DROP PARTITION (year=2018, month=11);
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned DROP IF EXISTS PARTITION (year=2017); -- Drop all partitions in 2017
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned DROP IF EXISTS PARTITION (month=9);
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SHOW PARTITIONS employee_partitioned;
+---------------------+--+
|      partition      |
+---------------------+--+
| year=2018/month=12  |
+---------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Rename partitions
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018, month=12) RENAME TO PARTITION (year=2018,month=10);
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SHOW PARTITIONS employee_partitioned;
+---------------------+--+
|      partition      |
+---------------------+--+
| year=2018/month=10  |
+---------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Load data to the partition
0: jdbc:hive2://localhost:10000/default> LOAD DATA LOCAL INPATH 'home/employee.txt' 
0: jdbc:hive2://localhost:10000/default> OVERWRITE INTO TABLE employee_partitioned
0: jdbc:hive2://localhost:10000/default> PARTITION (year=2018, month=12);
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Verify data loaded
0: jdbc:hive2://localhost:10000/default> SELECT name, year, month FROM employee_partitioned;
+----------+-------+--------+--+
|   name   | year  | month  |
+----------+-------+--------+--+
| Michael  | 2018  | 12     |
| Will     | 2018  | 12     |
| Shelley  | 2018  | 12     |
| Lucy     | 2018  | 12     |
+----------+-------+--------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Partition table add columns
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned ADD COLUMNS (work string) CASCADE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Change data type for partition columns
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION COLUMN(year string);
0: jdbc:hive2://localhost:10000/default> --Verify the changes
0: jdbc:hive2://localhost:10000/default> DESC employee_partitioned;
+--------------------------+--------------------------------+-----------------------+--+
|         col_name         |           data_type            |        comment        |
+--------------------------+--------------------------------+-----------------------+--+
| name                     | string                         |                       |
| work_place               | array<string>                  |                       |
| gender_age               | struct<gender:string,age:int>  |                       |
| skills_score             | map<string,int>                |                       |
| depart_title             | map<string,array<string>>      |                       |
| work                     | string                         |                       |
| year                     | string                         |                       |
| month                    | int                            |                       |
|                          | NULL                           | NULL                  |
| # Partition Information  | NULL                           | NULL                  |
| # col_name               | data_type                      | comment               |
|                          | NULL                           | NULL                  |
| year                     | string                         |                       |
| month                    | int                            |                       |
+--------------------------+--------------------------------+-----------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) SET FILEFORMAT ORC;
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) ENABLE NO_DROP;
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) ENABLE OFFLINE;
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) DISABLE NO_DROP;
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) DISABLE OFFLINE;
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) CONCATENATE;
Error: Error while compiling statement: FAILED: SemanticException org.apache.hadoop.hive.ql.parse.SemanticException: Partition not found {year=2018} (state=42000,code=40000)
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) SET FILEFORMAT TEXTFILE;
----

==== 7.5 Ошибка при обработке партиции

В предыдущем пункте возникла ошибка при выполнении оператора +
`ALTER TABLE employee_partitioned PARTITION (year=2018) CONCATENATE;`

Я попробовал перевести партицию снова в орк, выполнить снова concatenate
(подумал, может не успело что-то отработать).
Не помогло. Та же ошибка.
Почитал доку, вроде как concatenate применяется не к группе партиций, а к отдельной конкретной, чтобы ее, так сказать, дефрагментировать, смерджить малые файлы.
Попробовал выполнить concatenate по отношению к конкретной партиции.
Ошибка уже другая.
Оставил как есть, вернул на место.

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) SET FILEFORMAT ORC;
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) CONCATENATE;
Error: Error while compiling statement: FAILED: SemanticException org.apache.hadoop.hive.ql.parse.SemanticException: Partition not found {year=2018} (state=42000,code=40000)
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018, month=12) CONCATENATE;
Error: Error while processing statement: FAILED: Execution Error, return code 2 from org.apache.hadoop.hive.ql.exec.DDLTask (state=08S01,code=2)
0: jdbc:hive2://localhost:10000/default> ALTER TABLE employee_partitioned PARTITION (year=2018) SET FILEFORMAT TEXTFILE;
----

==== 8. Table bucketing

[source, sql]
----
jdbc:hive2://localhost:10000/default> --Prepare data for bucket tables
0: jdbc:hive2://localhost:10000/default> CREATE TABLE employee_id                         
0: jdbc:hive2://localhost:10000/default> (
0: jdbc:hive2://localhost:10000/default>   name string,
0: jdbc:hive2://localhost:10000/default>   employee_id int,
0: jdbc:hive2://localhost:10000/default>   work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default>   gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default>   skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default>   depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> COLLECTION ITEMS TERMINATED BY ','
0: jdbc:hive2://localhost:10000/default> MAP KEYS TERMINATED BY ':';
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> LOAD DATA LOCAL INPATH '/home/employee_id.txt' OVERWRITE INTO TABLE employee_id;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create the bucket table
0: jdbc:hive2://localhost:10000/default> CREATE TABLE employee_id_buckets                         
0: jdbc:hive2://localhost:10000/default> (
0: jdbc:hive2://localhost:10000/default>   name string,
0: jdbc:hive2://localhost:10000/default>   employee_id int,
0: jdbc:hive2://localhost:10000/default>   work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default>   gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default>   skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default>   depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> CLUSTERED BY (employee_id) INTO 2 BUCKETS
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> COLLECTION ITEMS TERMINATED BY ','
0: jdbc:hive2://localhost:10000/default> MAP KEYS TERMINATED BY ':';
0: jdbc:hive2://localhost:10000/default> set map.reduce.tasks = 2;
0: jdbc:hive2://localhost:10000/default> set hive.enforce.bucketing = true;
0: jdbc:hive2://localhost:10000/default> INSERT OVERWRITE TABLE employee_id_buckets SELECT * FROM employee_id;
----

[source, bash]
----
[root@quickstart /]# hdfs dfs -ls /user/hive/warehouse/employee_id_buckets
Found 2 items
-rwxrwxrwx   1 anonymous supergroup        768 2020-03-05 21:52 /user/hive/warehouse/employee_id_buckets/000000_0
-rwxrwxrwx   1 anonymous supergroup        704 2020-03-05 21:52 /user/hive/warehouse/employee_id_buckets/000001_0
----

=== Data manipulation

==== 1. Select

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Query all columns in the table
0: jdbc:hive2://localhost:10000/default> SELECT * FROM employee;
+----------------+-------------------------+-------------------------------+------------------------+----------------------------------------+--+
| employee.name  |   employee.work_place   |      employee.gender_age      | employee.skills_score  |         employee.depart_title          |
+----------------+-------------------------+-------------------------------+------------------------+----------------------------------------+--+
| Michael        | ["Montreal","Toronto"]  | {"gender":"Male","age":30}    | {"DB":80}              | {"Product":["Developer^DLead"]}        |
| Will           | ["Montreal"]            | {"gender":"Male","age":35}    | {"Perl":85}            | {"Product":["Lead"],"Test":["Lead"]}   |
| Shelley        | ["New York"]            | {"gender":"Female","age":27}  | {"Python":80}          | {"Test":["Lead"],"COE":["Architect"]}  |
| Lucy           | ["Vancouver"]           | {"gender":"Female","age":57}  | {"Sales":89,"HR":94}   | {"Sales":["Lead"]}                     |
+----------------+-------------------------+-------------------------------+------------------------+----------------------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Select only one column
0: jdbc:hive2://localhost:10000/default> SELECT name FROM employee;
+----------+--+
|   name   |
+----------+--+
| Michael  |
| Will     |
| Shelley  |
| Lucy     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --List columns meet java regular expression
0: jdbc:hive2://localhost:10000/default> SET hive.support.quoted.identifiers = none;
0: jdbc:hive2://localhost:10000/default> SELECT `^work.*` FROM employee;
+-------------------------+--+
|   employee.work_place   |
+-------------------------+--+
| ["Montreal","Toronto"]  |
| ["Montreal"]            |
| ["New York"]            |
| ["Vancouver"]           |
+-------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Select unique rows
0: jdbc:hive2://localhost:10000/default> SELECT DISTINCT name, work_place FROM employee;
+----------+-------------------------+--+
|   name   |       work_place        |
+----------+-------------------------+--+
| Lucy     | ["Vancouver"]           |
| Michael  | ["Montreal","Toronto"]  |
| Shelley  | ["New York"]            |
| Will     | ["Montreal"]            |
+----------+-------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Select with UDF, IF, and CASE WHEN
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> CASE WHEN gender_age.gender = 'Female' THEN 'Ms.'
0: jdbc:hive2://localhost:10000/default> ELSE 'Mr.' END as title,
0: jdbc:hive2://localhost:10000/default> name, 
0: jdbc:hive2://localhost:10000/default> IF(array_contains(work_place, 'New York'), 'US', 'CA') as country
0: jdbc:hive2://localhost:10000/default> FROM employee;
+--------+----------+----------+--+
| title  |   name   | country  |
+--------+----------+----------+--+
| Mr.    | Michael  | CA       |
| Mr.    | Will     | CA       |
| Ms.    | Shelley  | US       |
| Ms.    | Lucy     | CA       |
+--------+----------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Nest SELECT after the FROM
0: jdbc:hive2://localhost:10000/default> SELECT name, gender_age.gender AS gender
0: jdbc:hive2://localhost:10000/default> FROM(
0: jdbc:hive2://localhost:10000/default> SELECT * FROM employee
0: jdbc:hive2://localhost:10000/default> WHERE gender_age.gender = 'Male'
0: jdbc:hive2://localhost:10000/default> ) t1;
+----------+---------+--+
|   name   | gender  |
+----------+---------+--+
| Michael  | Male    |
| Will     | Male    |
+----------+---------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Nest SELECT using CTE
0: jdbc:hive2://localhost:10000/default> WITH t1 AS (
0: jdbc:hive2://localhost:10000/default> SELECT * FROM employee
0: jdbc:hive2://localhost:10000/default> WHERE gender_age.gender = 'Male')
0: jdbc:hive2://localhost:10000/default> SELECT name, gender_age.gender AS gender FROM t1;
+----------+---------+--+
|   name   | gender  |
+----------+---------+--+
| Michael  | Male    |
| Will     | Male    |
+----------+---------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Select with expression
0: jdbc:hive2://localhost:10000/default> SELECT concat('1','+','3','=',cast((1 + 3) as string)) as res;
+--------+--+
|  res   |
+--------+--+
| 1+3=4  |
+--------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Filter data with limit
0: jdbc:hive2://localhost:10000/default> SELECT name FROM employee LIMIT 2;
+----------+--+
|   name   |
+----------+--+
| Michael  |
| Will     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Filter with Where
0: jdbc:hive2://localhost:10000/default> SELECT name, work_place FROM employee WHERE name = 'Michael';
+----------+-------------------------+--+
|   name   |       work_place        |
+----------+-------------------------+--+
| Michael  | ["Montreal","Toronto"]  |
+----------+-------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Filter with Where and Limit
0: jdbc:hive2://localhost:10000/default> SELECT name, work_place FROM employee WHERE name = 'Michael' LIMIT 1;
+----------+-------------------------+--+
|   name   |       work_place        |
+----------+-------------------------+--+
| Michael  | ["Montreal","Toronto"]  |
+----------+-------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Filter with in
0: jdbc:hive2://localhost:10000/default> SELECT name FROM employee WHERE gender_age.age in (27, 30);
+----------+--+
|   name   |
+----------+--+
| Michael  |
| Shelley  |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Subquery in
0: jdbc:hive2://localhost:10000/default> SELECT name, gender_age.gender AS gender
0: jdbc:hive2://localhost:10000/default> FROM employee a
0: jdbc:hive2://localhost:10000/default> WHERE a.name IN (SELECT name FROM employee WHERE gender_age.gender = 'Male');
+----------+---------+--+
|   name   | gender  |
+----------+---------+--+
| Michael  | Male    |
| Will     | Male    |
+----------+---------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Subquery exists
0: jdbc:hive2://localhost:10000/default> SELECT name, gender_age.gender AS gender
0: jdbc:hive2://localhost:10000/default> FROM employee a
0: jdbc:hive2://localhost:10000/default> WHERE EXISTS
0: jdbc:hive2://localhost:10000/default> (SELECT * FROM employee b WHERE a.gender_age.gender = b.gender_age.gender AND b.gender_age.gender = 'Male');
+----------+---------+--+
|   name   | gender  |
+----------+---------+--+
| Michael  | Male    |
| Will     | Male    |
+----------+---------+--+
----

==== 2. Join

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Prepare another table for join and load data
0: jdbc:hive2://localhost:10000/default> CREATE TABLE IF NOT EXISTS employee_hr
0: jdbc:hive2://localhost:10000/default> (
0: jdbc:hive2://localhost:10000/default>   name string,
0: jdbc:hive2://localhost:10000/default>   employee_id int,
0: jdbc:hive2://localhost:10000/default>   sin_number string,
0: jdbc:hive2://localhost:10000/default>   start_date date
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> STORED AS TEXTFILE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> LOAD DATA LOCAL INPATH '/home/employee_hr.txt' OVERWRITE INTO TABLE employee_hr;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Equal JOIN between two tables
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> JOIN employee_hr emph ON emp.name = emph.name;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Will      | 527-948-090      |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Join with complex expression - conditional join
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> JOIN employee_hr emph ON 
0: jdbc:hive2://localhost:10000/default> IF(emp.name = 'Will', '1', emp.name) = CASE WHEN emph.name = 'Will' THEN '0' ELSE emph.name END;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> -- Use Where to limit the output of join
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> JOIN employee_hr emph ON emp.name = emph.name
0: jdbc:hive2://localhost:10000/default> WHERE
0: jdbc:hive2://localhost:10000/default> emp.name = 'Will';
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Will      | 527-948-090      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --JOIN between more tables
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, empi.employee_id, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> JOIN employee_hr emph ON emp.name = emph.name
0: jdbc:hive2://localhost:10000/default> JOIN employee_id empi ON emp.name = empi.name;
+-----------+-------------------+------------------+--+
| emp.name  | empi.employee_id  | emph.sin_number  |
+-----------+-------------------+------------------+--+
| Michael   | 100               | 547-968-091      |
| Will      | 101               | 527-948-090      |
| Lucy      | 103               | 577-928-094      |
+-----------+-------------------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Self join is used when the data in the table has nest logic
0: jdbc:hive2://localhost:10000/default> SELECT emp.name
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> JOIN employee emp_b
0: jdbc:hive2://localhost:10000/default> ON emp.name = emp_b.name;
+-----------+--+
| emp.name  |
+-----------+--+
| Michael   |
| Will      |
| Shelley   |
| Lucy      |
+-----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Implicit join, which support since Hive 0.13.0
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp, employee_hr emph
0: jdbc:hive2://localhost:10000/default> WHERE emp.name = emph.name;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Will      | 527-948-090      |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Left JOIN
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> LEFT JOIN employee_hr emph ON emp.name = emph.name;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Will      | 527-948-090      |
| Shelley   | NULL             |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Right JOIN
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> RIGHT JOIN employee_hr emph ON emp.name = emph.name;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Will      | 527-948-090      |
| NULL      | 647-968-598      |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Full OUTER JOIN
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> FULL JOIN employee_hr emph ON emp.name = emph.name;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Lucy      | 577-928-094      |
| Michael   | 547-968-091      |
| Shelley   | NULL             |
| NULL      | 647-968-598      |
| Will      | 527-948-090      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --CROSS JOIN in different ways
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> CROSS JOIN employee_hr emph;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Michael   | 527-948-090      |
| Michael   | 647-968-598      |
| Michael   | 577-928-094      |
| Will      | 547-968-091      |
| Will      | 527-948-090      |
| Will      | 647-968-598      |
| Will      | 577-928-094      |
| Shelley   | 547-968-091      |
| Shelley   | 527-948-090      |
| Shelley   | 647-968-598      |
| Shelley   | 577-928-094      |
| Lucy      | 547-968-091      |
| Lucy      | 527-948-090      |
| Lucy      | 647-968-598      |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> JOIN employee_hr emph;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Michael   | 527-948-090      |
| Michael   | 647-968-598      |
| Michael   | 577-928-094      |
| Will      | 547-968-091      |
| Will      | 527-948-090      |
| Will      | 647-968-598      |
| Will      | 577-928-094      |
| Shelley   | 547-968-091      |
| Shelley   | 527-948-090      |
| Shelley   | 647-968-598      |
| Shelley   | 577-928-094      |
| Lucy      | 547-968-091      |
| Lucy      | 527-948-090      |
| Lucy      | 647-968-598      |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> JOIN employee_hr emph on 1=1;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 547-968-091      |
| Michael   | 527-948-090      |
| Michael   | 647-968-598      |
| Michael   | 577-928-094      |
| Will      | 547-968-091      |
| Will      | 527-948-090      |
| Will      | 647-968-598      |
| Will      | 577-928-094      |
| Shelley   | 547-968-091      |
| Shelley   | 527-948-090      |
| Shelley   | 647-968-598      |
| Shelley   | 577-928-094      |
| Lucy      | 547-968-091      |
| Lucy      | 527-948-090      |
| Lucy      | 647-968-598      |
| Lucy      | 577-928-094      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --unequal JOIN
0: jdbc:hive2://localhost:10000/default> SELECT emp.name, emph.sin_number
0: jdbc:hive2://localhost:10000/default> FROM employee emp
0: jdbc:hive2://localhost:10000/default> CROSS JOIN employee_hr emph WHERE emp.name <> emph.name;
+-----------+------------------+--+
| emp.name  | emph.sin_number  |
+-----------+------------------+--+
| Michael   | 527-948-090      |
| Michael   | 647-968-598      |
| Michael   | 577-928-094      |
| Will      | 547-968-091      |
| Will      | 647-968-598      |
| Will      | 577-928-094      |
| Shelley   | 547-968-091      |
| Shelley   | 527-948-090      |
| Shelley   | 647-968-598      |
| Shelley   | 577-928-094      |
| Lucy      | 547-968-091      |
| Lucy      | 527-948-090      |
| Lucy      | 647-968-598      |
+-----------+------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --LEFT SEMI JOIN
0: jdbc:hive2://localhost:10000/default> SELECT a.name
0: jdbc:hive2://localhost:10000/default> FROM employee a
0: jdbc:hive2://localhost:10000/default> WHERE EXISTS
0: jdbc:hive2://localhost:10000/default> (SELECT * FROM employee_id b
0: jdbc:hive2://localhost:10000/default> WHERE a.name = b.name);
+----------+--+
|  a.name  |
+----------+--+
| Michael  |
| Will     |
| Shelley  |
| Lucy     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT a.name
0: jdbc:hive2://localhost:10000/default> FROM employee a
0: jdbc:hive2://localhost:10000/default> LEFT SEMI JOIN employee_id b
0: jdbc:hive2://localhost:10000/default> ON a.name = b.name;
+----------+--+
|  a.name  |
+----------+--+
| Michael  |
| Will     |
| Shelley  |
| Lucy     |
+----------+--+
----

==== 3. Union

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --UNION ALL including duplications
0: jdbc:hive2://localhost:10000/default> SELECT a.name as nm
0: jdbc:hive2://localhost:10000/default> FROM employee a
0: jdbc:hive2://localhost:10000/default> UNION ALL
0: jdbc:hive2://localhost:10000/default> SELECT b.name as nm
0: jdbc:hive2://localhost:10000/default> FROM employee_hr b;
+----------+--+
|  _u1.nm  |
+----------+--+
| Michael  |
| Will     |
| Shelley  |
| Lucy     |
| Michael  |
| Will     |
| Steven   |
| Lucy     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Order with UNION
0: jdbc:hive2://localhost:10000/default> SELECT a.name as nm FROM employee a
0: jdbc:hive2://localhost:10000/default> UNION ALL
0: jdbc:hive2://localhost:10000/default> SELECT b.name as nm FROM employee_hr b
0: jdbc:hive2://localhost:10000/default> ORDER BY nm;
+----------+--+
|  _u1.nm  |
+----------+--+
| Michael  |
| Will     |
| Shelley  |
| Lucy     |
| Lucy     |
| Michael  |
| Steven   |
| Will     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Table employee implements INTERCEPT employee_hr
0: jdbc:hive2://localhost:10000/default> SELECT a.name 
0: jdbc:hive2://localhost:10000/default> FROM employee a
0: jdbc:hive2://localhost:10000/default> JOIN employee_hr b
0: jdbc:hive2://localhost:10000/default> ON a.name = b.name;
+----------+--+
|  a.name  |
+----------+--+
| Michael  |
| Will     |
| Lucy     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Table employee implements MINUS employee_hr
0: jdbc:hive2://localhost:10000/default> SELECT a.name 
0: jdbc:hive2://localhost:10000/default> FROM employee a
0: jdbc:hive2://localhost:10000/default> LEFT JOIN employee_hr b
0: jdbc:hive2://localhost:10000/default> ON a.name = b.name
0: jdbc:hive2://localhost:10000/default> WHERE b.name IS NULL;
+----------+--+
|  a.name  |
+----------+--+
| Shelley  |
+----------+--+
----

==== 4. Insert export import

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Insert specified columns
0: jdbc:hive2://localhost:10000/default> CREATE TABLE emp_simple( -- Create a test table only has primary types
0: jdbc:hive2://localhost:10000/default> name string,
0: jdbc:hive2://localhost:10000/default> work_place string
0: jdbc:hive2://localhost:10000/default> );
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Insert values
0: jdbc:hive2://localhost:10000/default> INSERT INTO TABLE emp_simple VALUES ('Michael', 'Toronto'),('Lucy', 'Montreal');
0: jdbc:hive2://localhost:10000/default> SELECT * FROM emp_simple;
+------------------+------------------------+--+
| emp_simple.name  | emp_simple.work_place  |
+------------------+------------------------+--+
| Michael          | Toronto                |
| Lucy             | Montreal               |
+------------------+------------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> DROP TABLE IF EXISTS ctas_employee ;
0: jdbc:hive2://localhost:10000/default> CREATE TABLE ctas_employee AS SELECT * FROM employee_external;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --INSERT from CTE
0: jdbc:hive2://localhost:10000/default> WITH a as (SELECT * FROM ctas_employee )
0: jdbc:hive2://localhost:10000/default> FROM a
0: jdbc:hive2://localhost:10000/default> INSERT OVERWRITE TABLE employee
0: jdbc:hive2://localhost:10000/default> SELECT *;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Create partition table DDL
0: jdbc:hive2://localhost:10000/default> DROP TABLE IF EXISTS employee_partitioned ;
0: jdbc:hive2://localhost:10000/default> CREATE TABLE employee_partitioned
0: jdbc:hive2://localhost:10000/default> (
0: jdbc:hive2://localhost:10000/default>   name string,
0: jdbc:hive2://localhost:10000/default>   work_place ARRAY<string>,
0: jdbc:hive2://localhost:10000/default>   gender_age STRUCT<gender:string,age:int>,
0: jdbc:hive2://localhost:10000/default>   skills_score MAP<string,int>,
0: jdbc:hive2://localhost:10000/default>   depart_title MAP<STRING,ARRAY<STRING>>
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> PARTITIONED BY (Year INT, Month INT)
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> COLLECTION ITEMS TERMINATED BY ','
0: jdbc:hive2://localhost:10000/default> MAP KEYS TERMINATED BY ':';
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Dynamic partition is not enabled by default. We need to set following to make it work.
0: jdbc:hive2://localhost:10000/default> SET hive.exec.dynamic.partition=true;
0: jdbc:hive2://localhost:10000/default> SET hive.exec.dynamic.partition.mode=nostrict;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Dynamic partition insert
0: jdbc:hive2://localhost:10000/default> INSERT INTO TABLE employee_partitioned PARTITION(year, month)
0: jdbc:hive2://localhost:10000/default> SELECT name, array('Toronto') as work_place, 
0: jdbc:hive2://localhost:10000/default> named_struct("gender","Male","age",30) as gender_age,
0: jdbc:hive2://localhost:10000/default> map("Python",90) as skills_score,
0: jdbc:hive2://localhost:10000/default> map("R&D",array('Developer')) as depart_title, 
0: jdbc:hive2://localhost:10000/default> year(start_date) as year, month(start_date) as month
0: jdbc:hive2://localhost:10000/default> FROM employee_hr eh
0: jdbc:hive2://localhost:10000/default> WHERE eh.employee_id = 102;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SHOW PARTITIONS employee_partitioned;
+---------------------+--+
|      partition      |
+---------------------+--+
| year=2012/month=11  |
+---------------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Verify the inserted row
0: jdbc:hive2://localhost:10000/default> SELECT name,depart_title,year,month FROM employee_partitioned
0: jdbc:hive2://localhost:10000/default> WHERE name = 'Steven';
+---------+------------------------+-------+--------+--+
|  name   |      depart_title      | year  | month  |
+---------+------------------------+-------+--------+--+
| Steven  | {"R&D":["Developer"]}  | 2012  | 11     |
+---------+------------------------+-------+--------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Export data and metadata of table
0: jdbc:hive2://localhost:10000/default> EXPORT TABLE employee TO '/tmp/output';
0: jdbc:hive2://localhost:10000/default> !q
----

[source, bash]
----
[root@quickstart home]# hdfs dfs -ls -R /tmp/output/
-rwxrwxrwt   1 anonymous supergroup       1572 2020-03-05 22:40 /tmp/output/_metadata
drwxrwxrwt   - anonymous supergroup          0 2020-03-05 22:40 /tmp/output/data
-rwxrwxrwt   1 anonymous supergroup        228 2020-03-05 22:40 /tmp/output/data/000000_0
[root@quickstart home]# beeline -u "jdbc:hive2://localhost:10000/default" --silent=true
----

[NOTE]
Ниже при использовании опцционального `LOCATION '/tmp/outputext'` возникает ошибка,
без него все ок :)

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Import as new table
0: jdbc:hive2://localhost:10000/default> IMPORT TABLE employee_imported FROM '/tmp/output';
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Import as external table 
0: jdbc:hive2://localhost:10000/default> IMPORT EXTERNAL TABLE empolyee_imported_external 
0: jdbc:hive2://localhost:10000/default> FROM '/tmp/output'
0: jdbc:hive2://localhost:10000/default> LOCATION '/tmp/outputext' ; --Note, LOCATION property is optional.
Error: Error while compiling statement: FAILED: SemanticException Exception while processing (state=42000,code=40000)
0: jdbc:hive2://localhost:10000/default> IMPORT EXTERNAL TABLE empolyee_imported_external
0: jdbc:hive2://localhost:10000/default> FROM '/tmp/output';
0: jdbc:hive2://localhost:10000/default> select * from empolyee_imported_external;
+----------------------------------+----------------------------------------+----------------------------------------+------------------------------------------+------------------------------------------+--+
| empolyee_imported_external.name  | empolyee_imported_external.work_place  | empolyee_imported_external.gender_age  | empolyee_imported_external.skills_score  | empolyee_imported_external.depart_title  |
+----------------------------------+----------------------------------------+----------------------------------------+------------------------------------------+------------------------------------------+--+
| Michael                          | ["Montreal","Toronto"]                 | {"gender":"Male","age":30}             | {"DB":80}                                | {"Product":["Developer^DLead"]}          |
| Will                             | ["Montreal"]                           | {"gender":"Male","age":35}             | {"Perl":85}                              | {"Product":["Lead"],"Test":["Lead"]}     |
| Shelley                          | ["New York"]                           | {"gender":"Female","age":27}           | {"Python":80}                            | {"Test":["Lead"],"COE":["Architect"]}    |
| Lucy                             | ["Vancouver"]                          | {"gender":"Female","age":57}           | {"Sales":89,"HR":94}                     | {"Sales":["Lead"]}                       |
+----------------------------------+----------------------------------------+----------------------------------------+------------------------------------------+------------------------------------------+--+
----

==== 5. Order, sort, distribute by, cluster by

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --ORDER, SORT
0: jdbc:hive2://localhost:10000/default> SELECT name FROM employee ORDER BY name DESC;
+----------+--+
|   name   |
+----------+--+
| Will     |
| Shelley  |
| Michael  |
| Lucy     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Use more than 1 reducer
0: jdbc:hive2://localhost:10000/default> SET mapred.reduce.tasks = 2;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT name FROM employee SORT BY name DESC;   
+----------+--+
|   name   |
+----------+--+
| Shelley  |
| Michael  |
| Lucy     |
| Will     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Use only 1 reducer
0: jdbc:hive2://localhost:10000/default> SET mapred.reduce.tasks = 1; 
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT name FROM employee SORT BY name DESC;   
+----------+--+
|   name   |
+----------+--+
| Will     |
| Shelley  |
| Michael  |
| Lucy     |
+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Distribute by
0: jdbc:hive2://localhost:10000/default> SELECT name, employee_id 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr DISTRIBUTE BY employee_id ; 
+----------+--------------+--+
|   name   | employee_id  |
+----------+--------------+--+
| Lucy     | 103          |
| Steven   | 102          |
| Will     | 101          |
| Michael  | 100          |
+----------+--------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Used with SORT BY
0: jdbc:hive2://localhost:10000/default> SELECT name, start_date FROM employee_hr DISTRIBUTE BY start_date SORT BY name;
+----------+-------------+--+
|   name   | start_date  |
+----------+-------------+--+
| Lucy     | 2010-01-03  |
| Michael  | 2014-01-29  |
| Steven   | 2012-11-03  |
| Will     | 2013-10-02  |
+----------+-------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Cluster by
0: jdbc:hive2://localhost:10000/default> SELECT name, employee_id FROM employee_hr CLUSTER BY name ;
+----------+--------------+--+
|   name   | employee_id  |
+----------+--------------+--+
| Lucy     | 103          |
| Michael  | 100          |
| Steven   | 102          |
| Will     | 101          |
+----------+--------------+--+
----

=== Data aggregation

==== 1. Basic aggregation

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Aggregation without GROUP BY columns
0: jdbc:hive2://localhost:10000/default> SELECT count(*) as rowcnt1, count(1) AS rowcnt2 FROM employee;
+----------+----------+--+
| rowcnt1  | rowcnt2  |
+----------+----------+--+
| 4        | 4        |
+----------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Aggregation with GROUP BY columns
0: jdbc:hive2://localhost:10000/default> SELECT gender_age.gender, count(*) AS row_cnt FROM employee
0: jdbc:hive2://localhost:10000/default> GROUP BY gender_age.gender;
+--------------------+----------+--+
| gender_age.gender  | row_cnt  |
+--------------------+----------+--+
| Female             | 2        |
| Male               | 2        |
+--------------------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Multiple aggregate functions are called in the same SELECT
0: jdbc:hive2://localhost:10000/default> SELECT gender_age.gender, AVG(gender_age.age) AS avg_age,
0: jdbc:hive2://localhost:10000/default> count(*) AS row_cnt FROM employee GROUP BY gender_age.gender;
+--------------------+----------+----------+--+
| gender_age.gender  | avg_age  | row_cnt  |
+--------------------+----------+----------+--+
| Female             | 42.0     | 2        |
| Male               | 32.5     | 2        |
+--------------------+----------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Aggregate functions are used with CASE WHEN 
0: jdbc:hive2://localhost:10000/default> SELECT sum(CASE WHEN gender_age.gender = 'Male' THEN gender_age.age
0: jdbc:hive2://localhost:10000/default> ELSE 0 END)/count(CASE WHEN gender_age.gender = 'Male' THEN 1
0: jdbc:hive2://localhost:10000/default> ELSE NULL END) AS male_age_avg FROM employee;
+---------------+--+
| male_age_avg  |
+---------------+--+
| 32.5          |
+---------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Aggregate functions are used with COALESCE and IF 
0: jdbc:hive2://localhost:10000/default> SELECT
0: jdbc:hive2://localhost:10000/default> sum(coalesce(gender_age.age,0)) AS age_sum,
0: jdbc:hive2://localhost:10000/default> sum(if(gender_age.gender = 'Female',gender_age.age,0))
0: jdbc:hive2://localhost:10000/default> AS female_age_sum FROM employee;
+----------+-----------------+--+
| age_sum  | female_age_sum  |
+----------+-----------------+--+
| 149      | 84              |
+----------+-----------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Nested aggregate functions are not allowed
0: jdbc:hive2://localhost:10000/default> --FAILED: SemanticException [Error 10128]: Line 1:11 Not yet supported place for UDAF 'count'
0: jdbc:hive2://localhost:10000/default> --SELECT avg(count(*)) AS row_cnt FROM employee; 
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Aggregate functions cannot apply to null
0: jdbc:hive2://localhost:10000/default> --SELECT sum(null), avg(null); 
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Aggregate functions can be also used with DISTINCT keyword to do aggregation on unique values.
0: jdbc:hive2://localhost:10000/default> SELECT count(distinct gender_age.gender) AS gender_uni_cnt, count(distinct name) AS name_uni_cnt FROM employee;
+-----------------+---------------+--+
| gender_uni_cnt  | name_uni_cnt  |
+-----------------+---------------+--+
| 2               | 4             |
+-----------------+---------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Use max/min struct
0: jdbc:hive2://localhost:10000/default> SELECT gender_age.gender,
0: jdbc:hive2://localhost:10000/default> max(struct(gender_age.age, name)).col1 as age,
0: jdbc:hive2://localhost:10000/default> max(struct(gender_age.age, name)).col2 as name
0: jdbc:hive2://localhost:10000/default> FROM employee
0: jdbc:hive2://localhost:10000/default> GROUP BY gender_age.gender;
+--------------------+------+-------+--+
| gender_age.gender  | age  | name  |
+--------------------+------+-------+--+
| Female             | 57   | Lucy  |
| Male               | 35   | Will  |
+--------------------+------+-------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Use subquery to select unique value before aggregations for better performance
0: jdbc:hive2://localhost:10000/default> SELECT count(*) AS gender_uni_cnt FROM (SELECT distinct gender_age.gender FROM employee) a;
+-----------------+--+
| gender_uni_cnt  |
+-----------------+--+
| 2               |
+-----------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Grouping Set
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, 
0: jdbc:hive2://localhost:10000/default> start_date,
0: jdbc:hive2://localhost:10000/default> count(sin_number) as sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY name, start_date 
0: jdbc:hive2://localhost:10000/default> GROUPING SETS((name, start_date));
+----------+-------------+----------+--+
|   name   | start_date  | sin_cnt  |
+----------+-------------+----------+--+
| Lucy     | 2010-01-03  | 1        |
| Michael  | 2014-01-29  | 1        |
| Steven   | 2012-11-03  | 1        |
| Will     | 2013-10-02  | 1        |
+----------+-------------+----------+--+
0: jdbc:hive2://localhost:10000/default> --||-- equals to
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, 
0: jdbc:hive2://localhost:10000/default> start_date, 
0: jdbc:hive2://localhost:10000/default> count(sin_number) AS sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY name, start_date;
+----------+-------------+----------+--+
|   name   | start_date  | sin_cnt  |
+----------+-------------+----------+--+
| Lucy     | 2010-01-03  | 1        |
| Michael  | 2014-01-29  | 1        |
| Steven   | 2012-11-03  | 1        |
| Will     | 2013-10-02  | 1        |
+----------+-------------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, start_date, count(sin_number) as sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY name, start_date 
0: jdbc:hive2://localhost:10000/default> GROUPING SETS(name, start_date);
+----------+-------------+----------+--+
|   name   | start_date  | sin_cnt  |
+----------+-------------+----------+--+
| NULL     | 2010-01-03  | 1        |
| NULL     | 2012-11-03  | 1        |
| NULL     | 2013-10-02  | 1        |
| NULL     | 2014-01-29  | 1        |
| Lucy     | NULL        | 1        |
| Michael  | NULL        | 1        |
| Steven   | NULL        | 1        |
| Will     | NULL        | 1        |
+----------+-------------+----------+--+
0: jdbc:hive2://localhost:10000/default> --||-- equals to
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, null as start_date, count(sin_number) as sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY name
0: jdbc:hive2://localhost:10000/default> UNION ALL
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> null as name, start_date, count(sin_number) as sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY start_date;
+-----------+-----------------+--------------+--+
| _u1.name  | _u1.start_date  | _u1.sin_cnt  |
+-----------+-----------------+--------------+--+
| Lucy      | NULL            | 1            |
| Michael   | NULL            | 1            |
| Steven    | NULL            | 1            |
| Will      | NULL            | 1            |
| NULL      | 2010-01-03      | 1            |
| NULL      | 2012-11-03      | 1            |
| NULL      | 2013-10-02      | 1            |
| NULL      | 2014-01-29      | 1            |
+-----------+-----------------+--------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, start_date, count(sin_number) as sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY name, start_date 
0: jdbc:hive2://localhost:10000/default> GROUPING SETS((name, start_date), name);
+----------+-------------+----------+--+
|   name   | start_date  | sin_cnt  |
+----------+-------------+----------+--+
| Lucy     | NULL        | 1        |
| Lucy     | 2010-01-03  | 1        |
| Michael  | NULL        | 1        |
| Michael  | 2014-01-29  | 1        |
| Steven   | NULL        | 1        |
| Steven   | 2012-11-03  | 1        |
| Will     | NULL        | 1        |
| Will     | 2013-10-02  | 1        |
+----------+-------------+----------+--+
0: jdbc:hive2://localhost:10000/default> --||-- equals to
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, start_date, count(sin_number) as sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY name, start_date
0: jdbc:hive2://localhost:10000/default> UNION ALL
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, null as start_date, count(sin_number) as sin_cnt 
0: jdbc:hive2://localhost:10000/default> FROM employee_hr
0: jdbc:hive2://localhost:10000/default> GROUP BY name;
+-----------+-----------------+--------------+--+
| _u1.name  | _u1.start_date  | _u1.sin_cnt  |
+-----------+-----------------+--------------+--+
| Lucy      | 2010-01-03      | 1            |
| Michael   | 2014-01-29      | 1            |
| Steven    | 2012-11-03      | 1            |
| Will      | 2013-10-02      | 1            |
| Lucy      | NULL            | 1            |
| Michael   | NULL            | 1            |
| Steven    | NULL            | 1            |
| Will      | NULL            | 1            |
+-----------+-----------------+--------------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --Aggregation condition – HAVING
0: jdbc:hive2://localhost:10000/default> SELECT gender_age.age FROM employee GROUP BY gender_age.age HAVING count(*)=1;
+-----------------+--+
| gender_age.age  |
+-----------------+--+
| 27              |
| 30              |
| 35              |
| 57              |
+-----------------+--+
0: jdbc:hive2://localhost:10000/default> SELECT gender_age.age, count(*) as cnt FROM employee GROUP BY gender_age.age HAVING cnt=1;
+-----------------+------+--+
| gender_age.age  | cnt  |
+-----------------+------+--+
| 27              | 1    |
| 30              | 1    |
| 35              | 1    |
| 57              | 1    |
+-----------------+------+--+
----

==== 2. Windows functions

[source, sql]
----
0: jdbc:hive2://localhost:10000/default> --Prepare table and data for demonstration
0: jdbc:hive2://localhost:10000/default> CREATE TABLE IF NOT EXISTS employee_contract
0: jdbc:hive2://localhost:10000/default> (
0: jdbc:hive2://localhost:10000/default> name string,
0: jdbc:hive2://localhost:10000/default> dept_num int,
0: jdbc:hive2://localhost:10000/default> employee_id int,
0: jdbc:hive2://localhost:10000/default> salary int,
0: jdbc:hive2://localhost:10000/default> type string,
0: jdbc:hive2://localhost:10000/default> start_date date
0: jdbc:hive2://localhost:10000/default> )
0: jdbc:hive2://localhost:10000/default> ROW FORMAT DELIMITED
0: jdbc:hive2://localhost:10000/default> FIELDS TERMINATED BY '|'
0: jdbc:hive2://localhost:10000/default> STORED AS TEXTFILE;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> LOAD DATA LOCAL INPATH
0: jdbc:hive2://localhost:10000/default> '/home/employee_contract.txt' 
0: jdbc:hive2://localhost:10000/default> OVERWRITE INTO TABLE employee_contract;
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --window aggregate functions
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, 
0: jdbc:hive2://localhost:10000/default> dept_num as deptno, 
0: jdbc:hive2://localhost:10000/default> salary,
0: jdbc:hive2://localhost:10000/default> count(*) OVER (PARTITION BY dept_num) as cnt,
0: jdbc:hive2://localhost:10000/default> sum(salary) OVER(PARTITION BY dept_num ORDER BY dept_num) as sum1,
0: jdbc:hive2://localhost:10000/default> sum(salary) OVER(ORDER BY dept_num) as sum2
0: jdbc:hive2://localhost:10000/default> FROM employee_contract
0: jdbc:hive2://localhost:10000/default> ORDER BY deptno, name;
+----------+---------+---------+------+--------+--------+--+
|   name   | deptno  | salary  | cnt  |  sum1  |  sum2  |
+----------+---------+---------+------+--------+--------+--+
| Lucy     | 1000    | 5500    | 5    | 24900  | 24900  |
| Michael  | 1000    | 5000    | 5    | 24900  | 24900  |
| Steven   | 1000    | 6400    | 5    | 24900  | 24900  |
| Will     | 1000    | 4000    | 5    | 24900  | 24900  |
| Will     | 1000    | 4000    | 5    | 24900  | 24900  |
| Jess     | 1001    | 6000    | 3    | 17400  | 42300  |
| Lily     | 1001    | 5000    | 3    | 17400  | 42300  |
| Mike     | 1001    | 6400    | 3    | 17400  | 42300  |
| Richard  | 1002    | 8000    | 3    | 20500  | 62800  |
| Wei      | 1002    | 7000    | 3    | 20500  | 62800  |
| Yun      | 1002    | 5500    | 3    | 20500  | 62800  |
+----------+---------+---------+------+--------+--------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --window sorting functions
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, 
0: jdbc:hive2://localhost:10000/default> dept_num as deptno, 
0: jdbc:hive2://localhost:10000/default> salary,
0: jdbc:hive2://localhost:10000/default> row_number() OVER () as rnum,
0: jdbc:hive2://localhost:10000/default> rank() OVER (PARTITION BY dept_num ORDER BY salary) as rk, 
0: jdbc:hive2://localhost:10000/default> dense_rank() OVER (PARTITION BY dept_num ORDER BY salary) as drk,
0: jdbc:hive2://localhost:10000/default> percent_rank() OVER(PARTITION BY dept_num ORDER BY salary) as prk,
0: jdbc:hive2://localhost:10000/default> ntile(4) OVER(PARTITION BY dept_num ORDER BY salary) as ntile
0: jdbc:hive2://localhost:10000/default> FROM employee_contract
0: jdbc:hive2://localhost:10000/default> ORDER BY deptno, name;
+----------+---------+---------+-------+-----+------+-------+--------+--+
|   name   | deptno  | salary  | rnum  | rk  | drk  |  prk  | ntile  |
+----------+---------+---------+-------+-----+------+-------+--------+--+
| Lucy     | 1000    | 5500    | 7     | 4   | 3    | 0.75  | 3      |
| Michael  | 1000    | 5000    | 11    | 3   | 2    | 0.5   | 2      |
| Steven   | 1000    | 6400    | 8     | 5   | 4    | 1.0   | 4      |
| Will     | 1000    | 4000    | 9     | 1   | 1    | 0.0   | 1      |
| Will     | 1000    | 4000    | 10    | 1   | 1    | 0.0   | 1      |
| Jess     | 1001    | 6000    | 5     | 2   | 2    | 0.5   | 2      |
| Lily     | 1001    | 5000    | 6     | 1   | 1    | 0.0   | 1      |
| Mike     | 1001    | 6400    | 4     | 3   | 3    | 1.0   | 3      |
| Richard  | 1002    | 8000    | 1     | 3   | 3    | 1.0   | 3      |
| Wei      | 1002    | 7000    | 3     | 2   | 2    | 0.5   | 2      |
| Yun      | 1002    | 5500    | 2     | 1   | 1    | 0.0   | 1      |
+----------+---------+---------+-------+-----+------+-------+--------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --window analytics function
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name,
0: jdbc:hive2://localhost:10000/default> dept_num as deptno,
0: jdbc:hive2://localhost:10000/default> salary,
0: jdbc:hive2://localhost:10000/default> round(cume_dist() OVER (PARTITION BY dept_num ORDER BY salary), 2) as cume,
0: jdbc:hive2://localhost:10000/default> lead(salary, 2) OVER (PARTITION BY dept_num ORDER BY salary) as lead,
0: jdbc:hive2://localhost:10000/default> lag(salary, 2, 0) OVER (PARTITION BY dept_num ORDER BY salary) as lag,
0: jdbc:hive2://localhost:10000/default> first_value(salary) OVER (PARTITION BY dept_num ORDER BY salary) as fval,
0: jdbc:hive2://localhost:10000/default> last_value(salary) OVER (PARTITION BY dept_num ORDER BY salary) as lvalue,
0: jdbc:hive2://localhost:10000/default> last_value(salary) OVER (PARTITION BY dept_num ORDER BY salary RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS lvalue2
0: jdbc:hive2://localhost:10000/default> FROM employee_contract 
0: jdbc:hive2://localhost:10000/default> ORDER BY deptno, salary;
+----------+---------+---------+-------+-------+-------+-------+---------+----------+--+
|   name   | deptno  | salary  | cume  | lead  |  lag  | fval  | lvalue  | lvalue2  |
+----------+---------+---------+-------+-------+-------+-------+---------+----------+--+
| Will     | 1000    | 4000    | 0.4   | 5500  | 0     | 4000  | 4000    | 6400     |
| Will     | 1000    | 4000    | 0.4   | 5000  | 0     | 4000  | 4000    | 6400     |
| Michael  | 1000    | 5000    | 0.6   | 6400  | 4000  | 4000  | 5000    | 6400     |
| Lucy     | 1000    | 5500    | 0.8   | NULL  | 4000  | 4000  | 5500    | 6400     |
| Steven   | 1000    | 6400    | 1.0   | NULL  | 5000  | 4000  | 6400    | 6400     |
| Lily     | 1001    | 5000    | 0.33  | 6400  | 0     | 5000  | 5000    | 6400     |
| Jess     | 1001    | 6000    | 0.67  | NULL  | 0     | 5000  | 6000    | 6400     |
| Mike     | 1001    | 6400    | 1.0   | NULL  | 5000  | 5000  | 6400    | 6400     |
| Yun      | 1002    | 5500    | 0.33  | 8000  | 0     | 5500  | 5500    | 8000     |
| Wei      | 1002    | 7000    | 0.67  | NULL  | 0     | 5500  | 7000    | 8000     |
| Richard  | 1002    | 8000    | 1.0   | NULL  | 5500  | 5500  | 8000    | 8000     |
+----------+---------+---------+-------+-------+-------+-------+---------+----------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --window expression preceding and following
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, dept_num as dno, salary AS sal,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) win1,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN 2 PRECEDING AND UNBOUNDED FOLLOWING) win2,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN 1 PRECEDING AND 2 FOLLOWING) win3,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN 2 PRECEDING AND 1 PRECEDING) win4,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN 1 FOLLOWING AND 2 FOLLOWING) win5,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS 2 PRECEDING) win6,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS UNBOUNDED PRECEDING) win7
0: jdbc:hive2://localhost:10000/default> FROM employee_contract
0: jdbc:hive2://localhost:10000/default> ORDER BY dno, name;
+----------+-------+-------+-------+-------+-------+-------+-------+-------+-------+--+
|   name   |  dno  |  sal  | win1  | win2  | win3  | win4  | win5  | win6  | win7  |
+----------+-------+-------+-------+-------+-------+-------+-------+-------+-------+--+
| Lucy     | 1000  | 5500  | 5500  | 6400  | 6400  | NULL  | 6400  | 5500  | 5500  |
| Michael  | 1000  | 5000  | 5500  | 6400  | 6400  | 5500  | 6400  | 5500  | 5500  |
| Steven   | 1000  | 6400  | 6400  | 6400  | 6400  | 5500  | 4000  | 6400  | 6400  |
| Will     | 1000  | 4000  | 6400  | 6400  | 4000  | 6400  | NULL  | 6400  | 6400  |
| Will     | 1000  | 4000  | 6400  | 6400  | 6400  | 6400  | 4000  | 6400  | 6400  |
| Jess     | 1001  | 6000  | 6000  | 6400  | 6400  | NULL  | 6400  | 6000  | 6000  |
| Lily     | 1001  | 5000  | 6000  | 6400  | 6400  | 6000  | 6400  | 6000  | 6000  |
| Mike     | 1001  | 6400  | 6400  | 6400  | 6400  | 6000  | NULL  | 6400  | 6400  |
| Richard  | 1002  | 8000  | 8000  | 8000  | 8000  | NULL  | 7000  | 8000  | 8000  |
| Wei      | 1002  | 7000  | 8000  | 8000  | 8000  | 8000  | 5500  | 8000  | 8000  |
| Yun      | 1002  | 5500  | 8000  | 8000  | 7000  | 8000  | NULL  | 8000  | 8000  |
+----------+-------+-------+-------+-------+-------+-------+-------+-------+-------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --window expression current_row
0: jdbc:hive2://localhost:10000/default> SELECT 
0: jdbc:hive2://localhost:10000/default> name, dept_num as dno, salary AS sal,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN CURRENT ROW AND CURRENT ROW) win8,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN CURRENT ROW AND 1 FOLLOWING) win9,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING) win10,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING) win11,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) win12,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN UNBOUNDED PRECEDING AND 1 FOLLOWING) win13,
0: jdbc:hive2://localhost:10000/default> max(salary) OVER (PARTITION BY dept_num ORDER BY name ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) win14
0: jdbc:hive2://localhost:10000/default> FROM employee_contract
0: jdbc:hive2://localhost:10000/default> ORDER BY dno, name;
+----------+-------+-------+-------+-------+--------+--------+--------+--------+--------+--+
|   name   |  dno  |  sal  | win8  | win9  | win10  | win11  | win12  | win13  | win14  |
+----------+-------+-------+-------+-------+--------+--------+--------+--------+--------+--+
| Lucy     | 1000  | 5500  | 5500  | 5500  | 6400   | NULL   | 5500   | 5500   | 6400   |
| Michael  | 1000  | 5000  | 5000  | 6400  | 6400   | 5500   | 5500   | 6400   | 6400   |
| Steven   | 1000  | 6400  | 6400  | 6400  | 6400   | 5500   | 6400   | 6400   | 6400   |
| Will     | 1000  | 4000  | 4000  | 4000  | 4000   | 6400   | 6400   | 6400   | 6400   |
| Will     | 1000  | 4000  | 4000  | 4000  | 4000   | 6400   | 6400   | 6400   | 6400   |
| Jess     | 1001  | 6000  | 6000  | 6000  | 6400   | NULL   | 6000   | 6000   | 6400   |
| Lily     | 1001  | 5000  | 5000  | 6400  | 6400   | 6000   | 6000   | 6400   | 6400   |
| Mike     | 1001  | 6400  | 6400  | 6400  | 6400   | 6000   | 6400   | 6400   | 6400   |
| Richard  | 1002  | 8000  | 8000  | 8000  | 8000   | NULL   | 8000   | 8000   | 8000   |
| Wei      | 1002  | 7000  | 7000  | 7000  | 7000   | 8000   | 8000   | 8000   | 8000   |
| Yun      | 1002  | 5500  | 5500  | 5500  | 5500   | 8000   | 8000   | 8000   | 8000   |
+----------+-------+-------+-------+-------+--------+--------+--------+--------+--------+--+
0: jdbc:hive2://localhost:10000/default> 
0: jdbc:hive2://localhost:10000/default> --window reference
0: jdbc:hive2://localhost:10000/default> SELECT name, dept_num, salary,
0: jdbc:hive2://localhost:10000/default> MAX(salary) OVER w1 AS win1,
0: jdbc:hive2://localhost:10000/default> MAX(salary) OVER w2 AS win2,
0: jdbc:hive2://localhost:10000/default> MAX(salary) OVER w3 AS win3
0: jdbc:hive2://localhost:10000/default> FROM employee_contract
0: jdbc:hive2://localhost:10000/default> WINDOW
0: jdbc:hive2://localhost:10000/default> w1 as (PARTITION BY dept_num ORDER BY name ROWS BETWEEN 2 PRECEDING AND CURRENT ROW),
0: jdbc:hive2://localhost:10000/default> w2 as w3,
0: jdbc:hive2://localhost:10000/default> w3 as (PARTITION BY dept_num ORDER BY name ROWS BETWEEN 1 PRECEDING AND 2 FOLLOWING)
0: jdbc:hive2://localhost:10000/default> ;
+----------+-----------+---------+-------+-------+-------+--+
|   name   | dept_num  | salary  | win1  | win2  | win3  |
+----------+-----------+---------+-------+-------+-------+--+
| Lucy     | 1000      | 5500    | 5500  | 6400  | 6400  |
| Michael  | 1000      | 5000    | 5500  | 6400  | 6400  |
| Steven   | 1000      | 6400    | 6400  | 6400  | 6400  |
| Will     | 1000      | 4000    | 6400  | 6400  | 6400  |
| Will     | 1000      | 4000    | 6400  | 4000  | 4000  |
| Jess     | 1001      | 6000    | 6000  | 6400  | 6400  |
| Lily     | 1001      | 5000    | 6000  | 6400  | 6400  |
| Mike     | 1001      | 6400    | 6400  | 6400  | 6400  |
| Richard  | 1002      | 8000    | 8000  | 8000  | 8000  |
| Wei      | 1002      | 7000    | 8000  | 8000  | 8000  |
| Yun      | 1002      | 5500    | 8000  | 7000  | 7000  |
+----------+-----------+---------+-------+-------+-------+--+
----

== Выводы

* В общем и целом познакомился с настройкой клаудеры в облаке GCP, с ее компонентами (hive, hue...)
* Познакомился с учебным докер-образом с настроенной клаудерой
* Немного погонял учебные запросы в установленной и настроенной собственноручно в GCP клаудере
* Понял, что мои способности к настройке клаудеры еще очень далеки от идеала :)
* Выполнил в учебном докер-образе все приложенные задания, практически все выполнилось без ошибок. +
  Некоторые мелкие ошибки запротоколировал, буду далее изучать.
* Изучил все запросы в скрипте и их вывод. +
  Большинство конструкций мне знакомо по роду деятельности (разработчик и администратор оракла), +
  однако увидел и новые конструкции.
* Познакомился с синтаксисом hiveql, очень интересно.
